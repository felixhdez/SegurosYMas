@model Inspinia_MVC5_SeedProject.Models.Adenda

@{
    ViewBag.Title = "Details";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-4">
        <h2>Adendas</h2>
        <ol class="breadcrumb">
            <li>
                @Html.ActionLink("Lista", "Index")
            </li>
            <li class="active">
                <strong>Detalle</strong>
            </li>
        </ol>
    </div>
    <div class="col-sm-8">
        <div class="title-action">
            <a class="btn btn-success btn-outline dim" href="@Url.Action("Index","Adendas")"><i class="fa fa-arrow-left"></i>&nbsp;&nbsp;Regresar</a>
            <a class="btn btn-success btn-outline dim" onclick="Editar()"><i class="fa fa-edit"></i>&nbsp;&nbsp;Editar</a>
        </div>
    </div>
</div>




<div class="wrapper wrapper-content animated fadeInRight">

    <!--Fila para detalles generales de la adenda-->
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Datos Generales | @Model.NumAdenda</h5>
                    <div class="ibox-tools">
                        @*@Html.ActionLink("Create New", "Create", null, new { @class = "btn btn-primary btn-xs"})*@
                        <a class="collapse-link"><i class="fa fa-chevron-up" style="color: #bebebe;"></i></a>
                        <a class="close-link"><i class="fa fa-times" style="color: #bebebe;"></i></a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <br />
                        <div class="col-md-6 b-r">
                            <div class="table-responsive">
                                <table class="table table-bordered" style="border: solid 2px #bebebe;">
                                    <tbody>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Cliente</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Poliza.Cliente.NombreCompleto)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Producto</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Poliza.Producto.Codigo) | @Html.DisplayFor(model => model.Poliza.Producto.Descripcion)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Ramo</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Poliza.Producto.Ramo.Descripcion)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Aseguradora</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Poliza.Producto.Aseguradora.Descripcion)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">N° Adenda</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.NumAdenda)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Tipo de Adenda</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.TipoAdenda)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Fecha de Emisión</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.FechaEmision)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Vigencia</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.FechaDesde) a @Html.DisplayFor(model => model.FechaHasta)</th>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive">
                                <table class="table table-bordered" style="border: solid 2px #bebebe;">
                                    <tbody>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Tipo de Cambio</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.TipoDeCambio)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Suma asegurada</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.SumaAsegurada)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Prima Neta</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.PrimaNeta)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">IVA</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Iva)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Otros</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Otros)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Comisión $</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.ComisionEspecial)</th>
                                        </tr>
                                        <tr>
                                            <th style="text-transform:uppercase; background-color: #eee; width: 30%;">Comentario</th>
                                            <th style="font-weight:normal;">@Html.DisplayFor(model => model.Comentario)</th>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <h4> Detalle de Cuotas</h4>
                            <br />
                            <div class="table-responsive">
                                <table class="table table-bordered" style="border: solid 2px #bebebe;" id="tableDetalleCuotas">
                                    <tr style="text-transform:uppercase; background-color: #eee;">
                                        <th>N°</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Estado<button type="button" class="bagde bagde-navy fa fa-list-ul pull-right" style="float: right;" id="btnAbonos"></button></th>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Fila para bienes asegurados-->
    <div class="row">
        <div class="col-lg-4">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Bienes Asegurados</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link"><i class="fa fa-chevron-up" style="color: #bebebe;"></i></a>
                        <a class="close-link"><i class="fa fa-times" style="color: #bebebe;"></i></a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="tableBienes">
                            <thead>
                                <tr>
                                    <th>N° Certificado</th>
                                    <th>Observación</th>
                                    <th>¿Excluido?</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Características y Coberturas</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link"><i class="fa fa-chevron-up" style="color: #bebebe;"></i></a>
                        <a class="close-link"><i class="fa fa-times" style="color: #bebebe;"></i></a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-6 b-r">
                            <div class="table-responsive">
                                <table class="table" id="tableCaracteristicas">
                                    <thead>
                                        <tr>
                                            <th>Característica</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped" id="tableCoberturas">
                                    <thead>
                                        <tr>
                                            <th>Cobertura</th>
                                            <th>Suma Asegurada</th>
                                            <th>Deducible</th>
                                            <th>Prima</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
 </div>



<!--Modal para detalle de recibos-->
<div class="modal inmodal fade" id="modal-detalle" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Detalle de Pagos</h4>
            </div>
            <div class="modal-body">
                @Html.Partial("_DetalleRecibos")
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

@section scripts{
<link href="~/Content/DataTables/media/css/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/DataTables/media/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/DataTables/media/css/dataTables.jqueryui.min.css" rel="stylesheet" />
<script src="~/Scripts/DataTables/media/js/dataTables.bootstrap.min.js"></script>
<script src="~/Scripts/DataTables/media/js/dataTables.jqueryui.min.js"></script>
<script src="~/Scripts/DataTables/media/js/jquery.dataTables.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"> </script>
    <script>
        var dataTableBienes = null;
        var dataTableCaracteristicas = null;
        var dataTableCoberturas = null;

        // Crea una instancia de datatable para el detalle
        $(function () {
            dataTableBienes = $("#tableBienes").DataTable({
                "info": false,
                "paging": true,
                "ordering": true,
                "searching": false,
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "No hay bienes asegurados que mostrar",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                
                }, "columnDefs": [{
                    "targets": 3,
                    "render": function (data, type, row, meta) {
                        return "<button class='btn btn-sm btn-success' value='" + data + "' type='button'>Mostrar</button>";
                    }
                }]
            });

            dataTableCaracteristicas = $("#tableCaracteristicas").DataTable({
                "info": false,
                "paging": false,
                "ordering": true,
                "searching": false,
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "No hay características que mostrar.",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                }
            });

            dataTableCoberturas = $("#tableCoberturas").DataTable({
                "info": false,
                "paging": false,
                "ordering": true,
                "searching": false,
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "No hay coberturas que mostrar",
                    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    }
                }
            });
        });

        $(document).ready(function () {
            $.ajax({
                type: "GET",
                url: "/Adendas/RecuperarCuotas/" + @Model.Id,
                dataType: "JSON",
                success: function (list) {
                    for (var i = 0; i < list.list.length; i++) {
                        var htmltags = '<tr>'+ '<td>' + list.list[i].Cuotas + '</td>'+ '<td>' + list.list[i].Vence + '</td>'+'<td>' + list.list[i].Monto + '</td>' +'<td>' + list.list[i].Estado + '</td></tr>';
                        $("#tableDetalleCuotas tbody").append(htmltags);
                    }
                    $("#btnAbonos").val(list.list[0].CuotaId);
                }
            })

            $.ajax({
                type: "GET",
                url: "/BienesAsegurados/GetBienesXAdenda/" + @Model.Id,
                dataType: "JSON",
                success: function (list) {
                    dataTableBienes.clear().draw();
                    for (var i = 0; i < list.lista.length; i++) {
                        var exc = null;
                        if(list.lista[i].Excluido)
                            exc = "Sí";
                        else
                            exc = "No";
                        dataTableBienes.row.add([
                           list.lista[i].NumCertificado,
                           list.lista[i].Observacion,
                           exc,
                           list.lista[i].IdBien]).draw(false);
                    }
                }
            })
        });

        $("#btnAbonos").click(function(){
            //swal($(this).val());
            $.ajax({
                type:"GET",
                url: "/ReciboCuotas/GetRecibos/" + $(this).val(),
                dataType:"JSON",
                success: function(lista){
                    var fila;
                    $(".temporal").remove();
                    if(lista.lista.length >0)
                    {
                        for (var i = 0; i < lista.lista.length; i++) {
                            fila = "<tr class='temporal'><td>"+ lista.lista[i].Prima +"</td><td>" + lista.lista[i].Recibo +"</td><td>"+ lista.lista[i].Fecha +"</td><td>"+ lista.lista[i].Pago +"</td><td>" + lista.lista[i].PagoNeto +"</td></tr>";
                            $("#DetalleRecibos tbody").append(fila);
                        }
                    }
                    else
                    {
                        fila = "<tr class='temporal'> <td class='text-center' colspan='5'> Aún no hay recibos que mostrar.</td></tr>"
                        $("#DetalleRecibos tbody").append(fila);
                    }
                    $("#modal-detalle").modal("show");
                }
            });
        });

        $(function(){
            $("#tableBienes tbody").on('click', 'button', function () {
                var datos = dataTableBienes.row($(this).parents('tr')).data();
                console.log(datos);
                $.ajax({
                    type: "GET",
                    url: "/Polizas/RecuperarCaracteristicas/" + datos[3],
                    dataType: "JSON",
                    success: function (list) {
                        dataTableCaracteristicas.clear().draw();
                        for (var i = 0; i < list.list.length; i++) {
                            dataTableCaracteristicas.row.add([
                                list.list[i].Descripcion,
                                list.list[i].Valor
                            ]).draw(false);
                        }
                    }
                });

                $.ajax({
                    type: "GET",
                    url: "/Polizas/RecuperarCoberturas/" + datos[3],
                    dataType: "JSON",
                    success: function (list) {
                        dataTableCoberturas.clear().draw();
                        for (var i = 0; i < list.list.length; i++) {
                            dataTableCoberturas.row.add([
                                list.list[i].Descripcion,
                                list.list[i].Suma,
                                list.list[i].Deducible,
                                list.list[i].Prima
                            ]).draw(false);
                        }
                    }
                });
            });
        })

        function Editar()
        {
            window.location.href="/Adendas/Edit/"+ @Model.Id;
        };
    </script>
    }











